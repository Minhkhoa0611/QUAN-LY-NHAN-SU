<!DOCTYPE html>
<html style="zoom:90%;">
<head>
    <meta charset="utf-8">
    <title>TimePro HRM-Danh sách nhân viên</title>
        <link rel="icon" type="image/png" href="iconlogo.png">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg, #e3f0ff 0%, #f7f7f7 100%);
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px; /* tăng từ 900px lên 1200px */
            margin: 40px auto;
            background: #fff;
            padding: 32px 28px 28px 28px;
            border-radius: 18px;
            box-shadow: 0 4px 24px #0002;
            position: relative;
        }
        h2 {
            color: #1976d2;
            margin-bottom: 18px;
            letter-spacing: 1px;
            font-size: 2.8rem; /* tăng từ 2rem lên 2.8rem */
            text-align: center;
        }
        table {
            width: 100%;
            margin-top: 18px;
            border-radius: 10px;
            overflow: hidden;
            background: #f9fbfd;
            box-shadow: 0 2px 8px #0001;
            table-layout: fixed; /* đảm bảo các cột có thể set width */
            border-collapse: collapse; /* Thêm dòng này */
        }
        table, th, td {
            border: 1px solid #b3d1f7; /* Thay đổi từ border: none; */
        }
        th, td {
            padding: 12px 10px;
            text-align: left;
            /* ...existing code... */
        }
        th:nth-child(2), td:nth-child(2) {
            width: 150px; /* Tăng chiều rộng cột ID */
            min-width: 120px;
            max-width: 200px;
            word-break: break-all;
        }
        th {
            background: #e3f0ff; /* Làm header nổi bật hơn */
        }
        th.action-col, td.action-col {
            width: 260px; /* kéo dài cột hành động */
            min-width: 200px;
            text-align: left;
        }
        input[type="number"], input[type="text"], .emp-input {
            padding: 7px 10px;
            border-radius: 6px;
            border: 1.5px solid #b3d1f7;
            font-size: 15px;
            outline: none;
            transition: border 0.2s;
            background: #f7fbff;
        }
        input[type="number"]:focus, input[type="text"]:focus, .emp-input:focus {
            border: 1.5px solid #1976d2;
            background: #e3f0ff;
        }
        select.emp-input {
            height: 34px;
            /* Đảm bảo chiều cao đồng bộ với input */
        }
        .form-row {
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .form-row label {
            display: inline-block;
            width: 110px;
            color: #1976d2;
            font-weight: 500;
        }
        .btn {
            background: linear-gradient(90deg, #1976d2 60%, #2196f3 100%);
            color: #fff;
            border: none;
            padding: 8px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 2px 8px #1976d220;
            transition: background 0.2s, box-shadow 0.2s, transform 0.15s;
        }
        .btn:hover {
            background: linear-gradient(90deg, #1565c0 60%, #1976d2 100%);
            box-shadow: 0 4px 16px #1976d220;
            transform: translateY(-1px) scale(1.03);
        }
        .btn[style*="background:#e53935"] {
            background: linear-gradient(90deg, #e53935 60%, #ff5252 100%) !important;
        }
        .btn[style*="background:#e53935"]:hover {
            background: linear-gradient(90deg, #b71c1c 60%, #e53935 100%) !important;
        }
        .btn[style*="background:#43a047"] {
            background: linear-gradient(90deg, #43a047 60%, #66bb6a 100%) !important;
        }
        .btn[style*="background:#43a047"]:hover {
            background: linear-gradient(90deg, #2e7d32 60%, #43a047 100%) !important;
        }
        #addEmpForm {
            background: #f4f8fc;
            border-radius: 12px;
            box-shadow: 0 2px 8px #1976d210;
            padding: 18px 18px 10px 18px;
            margin-bottom: 18px;
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .emp-hide-checkbox {
            transform: scale(1.3);
            cursor: pointer;
        }
        .emp-eye-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            outline: none;
        }
        .emp-eye-icon {
            width: 22px;
            height: 22px;
            vertical-align: middle;
            fill: #1976d2;
            opacity: 0.85;
            transition: opacity 0.15s;
        }
        .emp-eye-btn:hover .emp-eye-icon {
            opacity: 1;
            fill: #e53935;
        }
        .copy-id-btn svg {
            transition: fill 0.15s, transform 0.15s;
        }
        .copy-id-btn:hover svg,
        .copy-id-btn.copied svg {
            fill: #43a047;
            transform: scale(1.18) rotate(-10deg);
        }
        .copy-id-btn:active svg {
            fill: #2e7d32;
        }
        @media (max-width: 700px) {
            .container { padding: 10px; }
            .form-row { flex-direction: column; align-items: flex-start; gap: 6px; }
            .form-row label { width: 100%; }
            table, th, td { font-size: 14px; }
        }
    </style>
    <script src="menu.js"></script>
    <script src="data_io.js"></script>
    <!-- Thư viện tạo QR code -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body>
    <script>renderMenu('emp');</script>
    <div class="container">
        <h2>Danh sách nhân viên</h2>
        <!-- Snackbar hoàn tác xóa -->
        <div id="undoDeleteSnackbar" style="display:none;position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:16px 28px;border-radius:8px;box-shadow:0 4px 24px #0005;z-index:3000;font-size:1.08rem;min-width:220px;text-align:center;">
            <span id="undoDeleteMsg"></span>
            <button id="undoDeleteBtn" style="margin-left:18px;background:#43a047;color:#fff;border:none;border-radius:6px;padding:6px 18px;font-size:1rem;font-weight:600;cursor:pointer;">Hoàn tác</button>
        </div>
        <form id="addEmpForm">
            <div class="form-row">
                <label>Tên:</label>
                <input id="empName" required class="emp-input">
                <label>Chức vụ:</label>
                <input id="empPos" class="emp-input">
            </div>
            <div class="form-row">
                <label>Cửa hàng:</label>
                <select id="empStore" class="emp-input" required>
                    <!-- Options sẽ được render động -->
                </select>
                <label style="width:110px"></label>
            </div>
            <div class="form-row">
                <label>Hình thức trả lương:</label>
                <select id="empSalaryType" required onchange="toggleSalaryInput()" class="emp-input">
                    <option value="base">Lương cơ bản</option>
                    <option value="shift">Lương theo ca</option>
                </select>
                <label id="empSalaryLabel" style="margin-left:18px;">Lương cơ bản:</label>
                <input id="empSalary" type="text" required oninput="formatCurrencyInput(this)">
                <button class="btn" type="submit" id="empSubmitBtn">Thêm</button>
            </div>
        </form>
        <table id="empTable">
            <thead>
                <tr>
                    <th>Tên</th>
                    <th>ID</th>
                    <th>Chức vụ</th>
                    <th>Cửa hàng</th>
                    <th>Hình thức trả lương</th>
                    <th>Lương cơ bản</th>
                    <th>Ẩn/Hiện</th>
                    <!-- Đã bỏ cột Thứ tự -->
                    <th class="action-col">Hành động</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <!-- Modal QR -->
        <div id="qrEmpModal" style="display:none;position:fixed;z-index:2000;left:0;top:0;width:100vw;height:100vh;background:#0005;">
            <div style="background:#fff;padding:24px 20px 16px 20px;border-radius:10px;max-width:350px;margin:80px auto;position:relative;box-shadow:0 4px 24px #0003;text-align:center;">
                <h3 style="margin-top:0;color:#1976d2;font-size:20px;">Mã QR nhân viên</h3>
                <div id="qrEmpName" style="font-weight:500;margin-bottom:8px;"></div>
                <canvas id="qrEmpCanvas" style="margin:0 auto;display:block;"></canvas>
                <div style="margin-top:14px;text-align:right;">
                    <button class="btn" style="background:#e53935" onclick="closeEmpQRModal()">Đóng</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Lấy dữ liệu nhân viên theo chuẩn trang minhkhoa0611.github.io/quanlynhansu (key: nhanvien)
        let employees = [];
        if (localStorage.getItem('employees')) {
            employees = JSON.parse(localStorage.getItem('employees'));
        } else if (localStorage.getItem('nhanvien')) {
            employees = JSON.parse(localStorage.getItem('nhanvien'));
            localStorage.setItem('employees', JSON.stringify(employees));
        } else if (localStorage.getItem('employees_backup')) {
            employees = JSON.parse(localStorage.getItem('employees_backup'));
            localStorage.setItem('employees', JSON.stringify(employees));
            alert('Dữ liệu nhân viên đã được phục hồi từ backup!');
        } else {
            employees = [];
        }
        // Luôn đồng bộ sang key nhanvien để tương thích
        localStorage.setItem('nhanvien', JSON.stringify(employees));
        let attendanceByMonth = JSON.parse(localStorage.getItem('attendanceByMonth') || '{}');
        let editEmpId = null;

        function renderStoreOptions(selectedValue = '') {
            // Chỉ cho phép chọn 2 cửa hàng: LepShop và H'farm
            const storeList = ["LepShop", "H'farm"];
            const empStore = document.getElementById('empStore');
            empStore.innerHTML = '<option value="">--Chọn cửa hàng--</option>';
            storeList.forEach(store => {
                const opt = document.createElement('option');
                opt.value = store;
                opt.textContent = store;
                if (selectedValue === store) opt.selected = true;
                empStore.appendChild(opt);
            });
            // Nếu có selectedValue mà không nằm trong 2 cửa hàng trên thì thêm vào cuối
            if (selectedValue && !storeList.includes(selectedValue)) {
                const opt = document.createElement('option');
                opt.value = selectedValue;
                opt.textContent = selectedValue;
                opt.selected = true;
                empStore.appendChild(opt);
            }
        }

        // --- Tự động cập nhật trường 'store' cho nhân viên theo ID ---
        function autoUpdateEmployeeStores() {
            // ID cho H'farm
            const hfarmIds = [
                "1748743379562",
                "1748743529323"
            ];
            employees.forEach(emp => {
                // Nếu nhân viên chưa có trường store hoặc store rỗng/null thì tự động gán
                if (!emp.store || emp.store === '') {
                    if (hfarmIds.includes(emp.id)) {
                        emp.store = "H'farm";
                    } else {
                        emp.store = "LepShop";
                    }
                }
                // Nếu đã có store thì giữ nguyên để người dùng có thể chỉnh sửa
            });
            saveEmployees();
        }
        // Gọi hàm này khi trang load để đảm bảo dữ liệu đúng
        autoUpdateEmployeeStores();

        // Bỏ hàm moveEmployee và các nút lên/xuống

        // Kéo thả để thay đổi thứ tự nhân viên
        function enableEmpDragDrop() {
            const tbody = document.querySelector('#empTable tbody');
            let dragIdx = null;

            tbody.querySelectorAll('tr').forEach((tr, idx) => {
                tr.draggable = true;
                tr.ondragstart = e => {
                    dragIdx = idx;
                    tr.style.opacity = '0.5';
                };
                tr.ondragend = e => {
                    tr.style.opacity = '';
                };
                tr.ondragover = e => {
                    e.preventDefault();
                    tr.style.background = '#bbdefb';
                };
                tr.ondragleave = e => {
                    tr.style.background = '';
                };
                tr.ondrop = e => {
                    e.preventDefault();
                    tr.style.background = '';
                    if (dragIdx === null || dragIdx === idx) return;
                    // Đổi vị trí trong mảng
                    const moved = employees.splice(dragIdx, 1)[0];
                    employees.splice(idx, 0, moved);
                    saveEmployees();
                    renderEmployees();
                };
            });
        }

        function renderEmployees() {
            const tbody = document.querySelector('#empTable tbody');
            tbody.innerHTML = '';
            employees.forEach((emp, idx) => {
                tbody.innerHTML += `<tr style="${emp.hidden ? 'opacity:0.5;background:#f8bbd0;' : ''}">
                    <td>${emp.name}</td>
                    <td>
                        <span style="display:inline-flex;align-items:center;gap:6px;position:relative;">
                            <span class="emp-id-text" style="user-select:all;">${emp.id}</span>
                            <button class="copy-id-btn" title="Copy ID" onclick="copyEmpIdToClipboard('${emp.id}', this)" style="background:none;border:none;cursor:pointer;padding:0;">
                                <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align:middle;fill:#1976d2;">
                                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 18H8V7h11v16z"/>
                                </svg>
                            </button>
                            <span class="copy-tooltip" style="display:none;position:absolute;top:-28px;left:0;background:#323232;color:#fff;padding:2px 10px;border-radius:5px;font-size:13px;white-space:nowrap;z-index:10;">Đã copy!</span>
                        </span>
                    </td>
                    <td>${emp.position}</td>
                    <td>${emp.store || ''}</td>
                    <td>${emp.salary_type === 'shift' ? 'Lương theo ca' : 'Lương cơ bản'}</td>
                    <td>${emp.salary_type === 'base' ? formatVND(emp.base_salary) : '<span style="color:#888">--</span>'}</td>
                    <td style="text-align:center;">
                        <button class="emp-eye-btn" title="${emp.hidden ? 'Hiện lại nhân viên này' : 'Ẩn nhân viên này'}" onclick="toggleHideEmployee('${emp.id}')">
                            ${emp.hidden
                                ? `<svg class="emp-eye-icon" viewBox="0 0 24 24">
                                    <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8a3 3 0 100 6 3 3 0 000-6z"/>
                                    <line x1="4" y1="4" x2="20" y2="20" stroke="#e53935" stroke-width="2"/>
                                  </svg>`
                                : `<svg class="emp-eye-icon" viewBox="0 0 24 24">
                                    <path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8a3 3 0 100 6 3 3 0 000-6z"/>
                                  </svg>`
                            }
                        </button>
                    </td>
                    <td class="action-col">
                        <button class="btn" onclick="editEmployee('${emp.id}')" ${emp.hidden ? 'disabled style="opacity:0.5;pointer-events:none;"' : ''}>Sửa</button>
                        <button class="btn" style="background:#e53935" onclick="deleteEmployee('${emp.id}')">Xóa</button>
                        <button class="btn" style="background:#43a047" onclick="showEmpQR('${emp.id}')">QR</button>
                    </td>
                </tr>`;
            });
            enableEmpDragDrop();
        }

        // Ẩn hoặc hiện nhân viên (toggle)
        function toggleHideEmployee(empId) {
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;
            emp.hidden = !emp.hidden;
            saveEmployees();
            renderEmployees();
            if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
        }
        window.toggleHideEmployee = toggleHideEmployee;

        function editEmployee(empId) {
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;
            empName.value = emp.name;
            empPos.value = emp.position;
            renderStoreOptions(emp.store || '');
            empSalaryType.value = emp.salary_type || 'base';
            toggleSalaryInput();
            empSalary.value = emp.salary_type === 'base' ? formatVND(emp.base_salary) : '';
            editEmpId = empId;
            document.getElementById('empSubmitBtn').textContent = 'Cập nhật';
        }

        // Biến lưu tạm nhân viên vừa xóa và dữ liệu liên quan
        let lastDeletedEmp = null;
        let undoDeleteTimer = null;

        function deleteEmployee(empId) {
            // Lưu lại dữ liệu nhân viên và các dữ liệu liên quan để hoàn tác
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;
            // Lưu các dữ liệu liên quan
            let backup = {
                emp: JSON.parse(JSON.stringify(emp)),
                attendance: {},
                shiftsByEmp: null,
                shiftsByEmpByMonth: {},
                payrollInputs: null,
                notes: [],
                workDaysStd: null,
                salaryPerDay: null
            };
            // Attendance
            Object.keys(attendanceByMonth).forEach(month => {
                if (attendanceByMonth[month][empId]) {
                    backup.attendance[month] = JSON.parse(JSON.stringify(attendanceByMonth[month][empId]));
                }
            });
            // shiftsByEmp
            let shiftsByEmp = JSON.parse(localStorage.getItem('shiftsByEmp') || '{}');
            if (shiftsByEmp[empId]) backup.shiftsByEmp = JSON.parse(JSON.stringify(shiftsByEmp[empId]));
            // shiftsByEmpByMonth
            let shiftsByEmpByMonth = JSON.parse(localStorage.getItem('shiftsByEmpByMonth') || '{}');
            Object.keys(shiftsByEmpByMonth).forEach(month => {
                if (shiftsByEmpByMonth[month][empId]) {
                    if (!backup.shiftsByEmpByMonth[month]) backup.shiftsByEmpByMonth[month] = {};
                    backup.shiftsByEmpByMonth[month] = JSON.parse(JSON.stringify(shiftsByEmpByMonth[month][empId]));
                }
            });
            // payrollInputs
            let payrollInputs = JSON.parse(localStorage.getItem('payrollInputs') || '{}');
            if (payrollInputs[empId]) backup.payrollInputs = JSON.parse(JSON.stringify(payrollInputs[empId]));
            // notes
            Object.keys(localStorage).forEach(k => {
                if (k.startsWith('note_' + empId)) {
                    backup.notes.push({ key: k, value: localStorage.getItem(k) });
                }
            });
            // workDaysStd & salaryPerDay riêng
            if (localStorage.getItem('workDaysStd_' + empId)) backup.workDaysStd = localStorage.getItem('workDaysStd_' + empId);
            if (localStorage.getItem('salaryPerDay_' + empId)) backup.salaryPerDay = localStorage.getItem('salaryPerDay_' + empId);

            // Xóa nhân viên và dữ liệu liên quan như cũ
            employees = employees.filter(e => e.id !== empId);
            localStorage.setItem('employees', JSON.stringify(employees));
            Object.keys(attendanceByMonth).forEach(month => {
                if (attendanceByMonth[month][empId]) delete attendanceByMonth[month][empId];
            });
            localStorage.setItem('attendanceByMonth', JSON.stringify(attendanceByMonth));
            if (shiftsByEmp[empId]) {
                delete shiftsByEmp[empId];
                if (Object.keys(shiftsByEmp).length === 0) {
                    localStorage.removeItem('shiftsByEmp');
                } else {
                    localStorage.setItem('shiftsByEmp', JSON.stringify(shiftsByEmp));
                }
            }
            let changed = false;
            Object.keys(shiftsByEmpByMonth).forEach(month => {
                if (shiftsByEmpByMonth[month][empId]) {
                    delete shiftsByEmpByMonth[month][empId];
                    changed = true;
                }
                if (Object.keys(shiftsByEmpByMonth[month]).length === 0) {
                    delete shiftsByEmpByMonth[month];
                    changed = true;
                }
            });
            if (changed) {
                if (Object.keys(shiftsByEmpByMonth).length === 0) {
                    localStorage.removeItem('shiftsByEmpByMonth');
                } else {
                    localStorage.setItem('shiftsByEmpByMonth', JSON.stringify(shiftsByEmpByMonth));
                }
            }
            if (payrollInputs[empId]) {
                delete payrollInputs[empId];
                if (Object.keys(payrollInputs).length === 0) {
                    localStorage.removeItem('payrollInputs');
                } else {
                    localStorage.setItem('payrollInputs', JSON.stringify(payrollInputs));
                }
            }
            Object.keys(localStorage).forEach(k => {
                if (k.startsWith('note_' + empId)) localStorage.removeItem(k);
            });
            localStorage.removeItem('workDaysStd_' + empId);
            localStorage.removeItem('salaryPerDay_' + empId);
            renderEmployees();
            if (employees.length === 0) {
                localStorage.removeItem('shifts');
            }
            if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();

            // Hiển thị snackbar hoàn tác
            lastDeletedEmp = backup;
            showUndoDeleteSnackbar(emp.name);
        }

        function showUndoDeleteSnackbar(empName) {
            clearTimeout(undoDeleteTimer);
            const snackbar = document.getElementById('undoDeleteSnackbar');
            document.getElementById('undoDeleteMsg').textContent = `Đã xóa nhân viên "${empName}".`;
            snackbar.style.display = '';
            undoDeleteTimer = setTimeout(() => {
                snackbar.style.display = 'none';
                lastDeletedEmp = null;
            }, 10000);
        }

        document.getElementById('undoDeleteBtn').onclick = function() {
            if (!lastDeletedEmp) return;
            // Phục hồi nhân viên
            employees.push(lastDeletedEmp.emp);
            localStorage.setItem('employees', JSON.stringify(employees));
            // Phục hồi attendance
            let attendanceByMonth = JSON.parse(localStorage.getItem('attendanceByMonth') || '{}');
            Object.keys(lastDeletedEmp.attendance).forEach(month => {
                if (!attendanceByMonth[month]) attendanceByMonth[month] = {};
                attendanceByMonth[month][lastDeletedEmp.emp.id] = lastDeletedEmp.attendance[month];
            });
            localStorage.setItem('attendanceByMonth', JSON.stringify(attendanceByMonth));
            // Phục hồi shiftsByEmp
            if (lastDeletedEmp.shiftsByEmp) {
                let shiftsByEmp = JSON.parse(localStorage.getItem('shiftsByEmp') || '{}');
                shiftsByEmp[lastDeletedEmp.emp.id] = lastDeletedEmp.shiftsByEmp;
                localStorage.setItem('shiftsByEmp', JSON.stringify(shiftsByEmp));
            }
            // Phục hồi shiftsByEmpByMonth
            if (lastDeletedEmp.shiftsByEmpByMonth) {
                let shiftsByEmpByMonth = JSON.parse(localStorage.getItem('shiftsByEmpByMonth') || '{}');
                Object.keys(lastDeletedEmp.shiftsByEmpByMonth).forEach(month => {
                    if (!shiftsByEmpByMonth[month]) shiftsByEmpByMonth[month] = {};
                    shiftsByEmpByMonth[month][lastDeletedEmp.emp.id] = lastDeletedEmp.shiftsByEmpByMonth[month];
                });
                localStorage.setItem('shiftsByEmpByMonth', JSON.stringify(shiftsByEmpByMonth));
            }
            // Phục hồi payrollInputs
            if (lastDeletedEmp.payrollInputs) {
                let payrollInputs = JSON.parse(localStorage.getItem('payrollInputs') || '{}');
                payrollInputs[lastDeletedEmp.emp.id] = lastDeletedEmp.payrollInputs;
                localStorage.setItem('payrollInputs', JSON.stringify(payrollInputs));
            }
            // Phục hồi notes
            if (lastDeletedEmp.notes && lastDeletedEmp.notes.length > 0) {
                lastDeletedEmp.notes.forEach(n => {
                    localStorage.setItem(n.key, n.value);
                });
            }
            // Phục hồi workDaysStd & salaryPerDay riêng
            if (lastDeletedEmp.workDaysStd) localStorage.setItem('workDaysStd_' + lastDeletedEmp.emp.id, lastDeletedEmp.workDaysStd);
            if (lastDeletedEmp.salaryPerDay) localStorage.setItem('salaryPerDay_' + lastDeletedEmp.emp.id, lastDeletedEmp.salaryPerDay);

            renderEmployees();
            document.getElementById('undoDeleteSnackbar').style.display = 'none';
            lastDeletedEmp = null;
            if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
        };

        document.getElementById('addEmpForm').onsubmit = function(e) {
            e.preventDefault();
            const salaryType = empSalaryType.value;
            const salary = salaryType === 'base' ? parseCurrency(empSalary.value) : 0;
            const store = empStore.value;
            if (editEmpId) {
                // Cập nhật
                const emp = employees.find(e => e.id === editEmpId);
                emp.name = empName.value;
                emp.position = empPos.value;
                emp.store = store;
                emp.salary_type = salaryType;
                emp.base_salary = salary;
                // Khi cập nhật không thay đổi trạng thái ẩn/hiện
                editEmpId = null;
                document.getElementById('empSubmitBtn').textContent = 'Thêm';
            } else {
                // Thêm mới
                const emp = {
                    id: Date.now().toString(),
                    name: empName.value,
                    position: empPos.value,
                    store: store,
                    salary_type: salaryType,
                    base_salary: salary,
                    hidden: false // Mặc định là hiện
                };
                employees.push(emp);
            }
            saveEmployees();
            renderEmployees();
            this.reset();
            renderStoreOptions();
            empSalaryType.value = 'base';
            toggleSalaryInput();
            if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
        };

        function saveEmployees() {
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('nhanvien', JSON.stringify(employees)); // đồng bộ với trang kia
            // Lưu backup mỗi lần cập nhật
            localStorage.setItem('employees_backup', JSON.stringify(employees));
        }

        function formatVND(val) {
            if (isNaN(val)) return '';
            return Number(val).toLocaleString('vi-VN') + ' ₫';
        }
        function parseCurrency(val) {
            return Number((val+'').replace(/[^\d]/g, '')) || 0;
        }
        function formatCurrencyInput(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (!value) value = '0';
            input.value = Number(value).toLocaleString('vi-VN');
        }

        function exportAllData() {
            const data = typeof getExportData === 'function' ? getExportData() : {};
            // Lấy tên cửa hàng từ localStorage
            const storeName = (localStorage.getItem('storeName') || 'LepShop').trim();
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const fileName = `${storeName.replace(/[^a-zA-Z0-9]/g, '')}-${pad(now.getDate())}-${pad(now.getMonth()+1)}-${now.getFullYear()}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.employees && data.attendanceByMonth) {
                        // Merge employees
                        let oldEmployees = JSON.parse(localStorage.getItem('employees') || '[]');
                        let newEmployees = data.employees || [];
                        let empMap = {};
                        oldEmployees.forEach(e => empMap[e.id] = e);
                        newEmployees.forEach(e => empMap[e.id] = e);
                        let mergedEmployees = Object.values(empMap);

                        // Merge attendanceByMonth
                        let oldAtt = JSON.parse(localStorage.getItem('attendanceByMonth') || '{}');
                        let newAtt = data.attendanceByMonth || {};
                        for (let month in newAtt) {
                            if (!oldAtt[month]) oldAtt[month] = {};
                            for (let empId in newAtt[month]) {
                                if (!oldAtt[month][empId]) oldAtt[month][empId] = {};
                                for (let day in newAtt[month][empId]) {
                                    oldAtt[month][empId][day] = newAtt[month][empId][day];
                                }
                            }
                        }

                        // Merge shifts
                        let oldShifts = JSON.parse(localStorage.getItem('shifts') || '[]');
                        let newShifts = data.shifts || [];
                        let shiftMap = {};
                        oldShifts.forEach(s => shiftMap[s.id] = s);
                        newShifts.forEach(s => shiftMap[s.id] = s);
                        let mergedShifts = Object.values(shiftMap);

                        // Merge shiftsByEmp
                        let oldShiftsByEmp = JSON.parse(localStorage.getItem('shiftsByEmp') || '{}');
                        let newShiftsByEmp = data.shiftsByEmp || {};
                        for (let empId in newShiftsByEmp) {
                            if (!oldShiftsByEmp[empId]) oldShiftsByEmp[empId] = [];
                            let oldArr = oldShiftsByEmp[empId];
                            let newArr = newShiftsByEmp[empId];
                            for (let i = 0; i < newArr.length; ++i) {
                                let exists = oldArr.some(s =>
                                    s.name === newArr[i].name &&
                                    s.start === newArr[i].start &&
                                    s.end === newArr[i].end &&
                                    s.salary === newArr[i].salary
                                );
                                if (!exists) oldArr.push(newArr[i]);
                            }
                        }

                        // Merge shiftsByEmpByMonth
                        let oldShiftsByEmpByMonth = JSON.parse(localStorage.getItem('shiftsByEmpByMonth') || '{}');
                        let newShiftsByEmpByMonth = data.shiftsByEmpByMonth || {};
                        for (let month in newShiftsByEmpByMonth) {
                            if (!oldShiftsByEmpByMonth[month]) oldShiftsByEmpByMonth[month] = {};
                            for (let empId in newShiftsByEmpByMonth[month]) {
                                oldShiftsByEmpByMonth[month][empId] = newShiftsByEmpByMonth[month][empId];
                            }
                        }

                        // Merge workDaysStd & salaryPerDay (ưu tiên giữ giá trị lớn nhất)
                        let workDaysStd = Math.max(
                            parseInt(localStorage.getItem('workDaysStd') || '26'),
                            parseInt(data.workDaysStd || '26')
                        );
                        let salaryPerDay = Math.max(
                            parseInt(localStorage.getItem('salaryPerDay') || '0'),
                            parseInt(data.salaryPerDay || '0')
                        );

                        // Áp dụng lại workDaysStdByEmp và salaryPerDayByEmp nếu có
                        if (data.workDaysStdByEmp) {
                            Object.keys(data.workDaysStdByEmp).forEach(empId => {
                                localStorage.setItem('workDaysStd_' + empId, data.workDaysStdByEmp[empId]);
                            });
                        }
                        if (data.salaryPerDayByEmp) {
                            Object.keys(data.salaryPerDayByEmp).forEach(empId => {
                                localStorage.setItem('salaryPerDay_' + empId, data.salaryPerDayByEmp[empId]);
                            });
                        }

                        // Save merged data
                        localStorage.setItem('employees', JSON.stringify(mergedEmployees));
                        localStorage.setItem('attendanceByMonth', JSON.stringify(oldAtt));
                        localStorage.setItem('shifts', JSON.stringify(mergedShifts));
                        localStorage.setItem('shiftsByEmp', JSON.stringify(oldShiftsByEmp));
                        localStorage.setItem('shiftsByEmpByMonth', JSON.stringify(oldShiftsByEmpByMonth));
                        localStorage.setItem('workDaysStd', workDaysStd.toString());
                        localStorage.setItem('salaryPerDay', salaryPerDay.toString());
                        // Thêm các dòng sau để đồng bộ lịch làm việc
                        if (data.workSchedules) localStorage.setItem('workSchedules', JSON.stringify(data.workSchedules));
                        if (data.scheduleShiftsByMonth) localStorage.setItem('scheduleShiftsByMonth', JSON.stringify(data.scheduleShiftsByMonth));
                        if (data.workScheduleWeekTemplate) localStorage.setItem('workScheduleWeekTemplate', JSON.stringify(data.workScheduleWeekTemplate));
                        if (data.workScheduleWeekNames) localStorage.setItem('workScheduleWeekNames', JSON.stringify(data.workScheduleWeekNames));
                        // Merge notes nếu có
                        if (data.notes) {
                            Object.keys(localStorage).forEach(k => {
                                if (k.startsWith('note_')) localStorage.removeItem(k);
                            });
                            for (let k in data.notes) {
                                localStorage.setItem(k, data.notes[k]);
                            }
                        }

                        alert('Nhập dữ liệu thành công! Trang sẽ được tải lại.');
                        if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
                        location.reload();
                    } else {
                        alert('File không đúng định dạng!');
                    }
                } catch (err) {
                    alert('Lỗi khi đọc file dữ liệu!');
                }
            };
            reader.readAsText(file);
        }

        function toggleSalaryInput() {
            const type = empSalaryType.value;
            if (type === 'base') {
                empSalary.disabled = false;
                empSalary.required = true;
                document.getElementById('empSalaryLabel').style.color = '';
                empSalary.style.background = '';
                // Không set mặc định 800000 khi chuyển sang lương cơ bản
                // empSalary.value = empSalary.value || ''; // Không gán giá trị mặc định
            } else {
                empSalary.disabled = true;
                empSalary.required = false;
                empSalary.value = '';
                document.getElementById('empSalaryLabel').style.color = '#aaa';
                empSalary.style.background = '#eee';
            }
        }

        window.toggleSalaryInput = toggleSalaryInput;
        toggleSalaryInput();

        renderStoreOptions();
        renderEmployees();
        
        // Đồng bộ dữ liệu nhân viên giữa các tab/trang
        window.addEventListener('storage', function(e) {
            if (e.key === 'employees') {
                employees = JSON.parse(localStorage.getItem('employees') || '[]');
                renderEmployees();
            }
        });

        function showEmpQR(empId) {
            const emp = employees.find(e => e.id === empId);
            if (!emp) return;
            document.getElementById('qrEmpName').textContent = emp.name + (emp.position ? ' - ' + emp.position : '');
            // Tạo QR code với emp.id
            const qr = new QRious({
                element: document.getElementById('qrEmpCanvas'),
                value: emp.id,
                size: 220,
                level: 'H'
            });
            document.getElementById('qrEmpModal').style.display = '';
        }
        function closeEmpQRModal() {
            document.getElementById('qrEmpModal').style.display = 'none';
        }
        // Đóng modal khi bấm ra ngoài
        document.addEventListener('mousedown', function(e) {
            const modal = document.getElementById('qrEmpModal');
            if (modal.style.display !== 'none' && !modal.querySelector('div').contains(e.target)) {
                closeEmpQRModal();
            }
        });

        // Đảm bảo các hàm QR có thể gọi từ HTML
        window.showEmpQR = showEmpQR;
        window.closeEmpQRModal = closeEmpQRModal;

        function copyEmpIdToClipboard(empId, btn) {
            navigator.clipboard.writeText(empId).then(() => {
                // Hiện tooltip "Đã copy!" tạm thời
                const wrapper = btn.parentElement;
                const tooltip = wrapper.querySelector('.copy-tooltip');
                btn.classList.add('copied');
                if (tooltip) {
                    tooltip.style.display = 'inline-block';
                    setTimeout(() => {
                        tooltip.style.display = 'none';
                        btn.classList.remove('copied');
                    }, 1200);
                } else {
                    setTimeout(() => {
                        btn.classList.remove('copied');
                    }, 1200);
                }
                btn.blur();
            });
        }
        window.copyEmpIdToClipboard = copyEmpIdToClipboard;
    </script>
    <script src="footer.js"></script>
    <script>renderFooter();</script>
</body>
</html>

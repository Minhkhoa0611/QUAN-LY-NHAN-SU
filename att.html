<!DOCTYPE html>
<html style="zoom:90%;">
<head>
    <meta charset="utf-8">
    <title>TimePro HRM-Ch·∫•m c√¥ng</title>
        <link rel="icon" type="image/png" href="iconlogo.png">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg, #e3f0ff 0%, #f7f7f7 100%);
            margin: 0;
        }
        .container {
            max-width: 1100px;
            margin: 38px auto 30px auto;
            background: #ffffffee; /* l√†m s√°ng h∆°n, th√™m ƒë·ªô trong su·ªët nh·∫π */
            padding: 32px 28px 28px 28px;
            border-radius: 18px;
            box-shadow: 0 8px 32px #1976d230, 0 1.5px 4px #0001;
        }
        h2 {
            color: #1976d2;
            font-size: 2rem;
            margin-bottom: 18px;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #1976d220;
        }
        table {
            width: 100%;
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            background: #fafcff;
            box-shadow: 0 2px 8px #0001;
        }
        table, th, td {
            border: 1px solid #e3eaf3;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px 6px;
            text-align: center;
            font-size: 15px;
        }
        th {
            background: #e3f0ff;
            color: #1976d2;
            font-weight: 600;
        }
        input[type="number"], input[type="text"], input[type="time"], input[type="month"] {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #b0bec5;
            font-size: 15px;
            background: #f7fafd;
            transition: border 0.2s;
        }
        input[type="number"]:focus, input[type="text"]:focus, input[type="time"]:focus, input[type="month"]:focus {
            border: 1.5px solid #1976d2;
            outline: none;
            background: #e3f0ff;
        }
        .form-row {
            margin-bottom: 18px;
        }
        .form-row label {
            display: inline-block;
            width: 120px;
            font-weight: 500;
            color: #1976d2;
        }
        .btn {
            background: linear-gradient(90deg, #1976d2 60%, #2196f3 100%);
            color: #fff;
            border: none;
            padding: 7px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 2px 8px #1976d220;
            transition: background 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            background: linear-gradient(90deg, #1565c0 60%, #1976d2 100%);
            box-shadow: 0 4px 16px #1976d220;
        }
        .shift-setup-table input[type="text"], .shift-setup-table input[type="time"] {
            width: 90px;
        }
        .shift-setup-table th, .shift-setup-table td {
            padding: 7px 4px;
        }
        .shift-setup-table tr td:last-child {
            text-align: center;
        }
        .shift-setup-table tr td button {
            padding: 5px 14px;
            font-size: 14px;
        }
        .shift-setup-table tr td button.btn {
            background: #e53935;
            background: linear-gradient(90deg, #e53935 60%, #ff7043 100%);
        }
        .shift-setup-table tr td button.btn:hover {
            background: #b71c1c;
        }
        .emp-row-color-0 { background: #e8f5e9; }
        .emp-row-color-1 { background: #f3e5f5; }
        .emp-row-color-2 { background: #e3f2fd; }
        .emp-row-color-3 { background: #fffde7; }
        .emp-row-color-4 { background: #fce4ec; }
        .emp-row-color-5 { background: #e0f2f1; }
        .emp-row-color-6 { background: #fbe9e7; }
        /* Employee table wrapper */
        #attTableWrap > div {
            background: #f7fafd;
            border-radius: 14px;
            box-shadow: 0 2px 12px #1976d210;
            padding: 18px 18px 10px 18px;
            margin-bottom: 36px;
            border: 1.5px solid #e3f0ff;
            transition: box-shadow 0.2s;
        }
        #attTableWrap > div:hover {
            box-shadow: 0 6px 24px #1976d230;
        }
        /* Employee name */
        #attTableWrap > div > div {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 12px;
            color: #1976d2;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 8px #1976d220;
        }
        /* Shift legend */
        #shiftLegend span {
            background: #e3f0ff;
            color: #1976d2;
            border-radius: 6px;
            padding: 4px 12px;
            margin-right: 8px;
            font-size: 15px;
            box-shadow: 0 1px 4px #1976d210;
            display: inline-block;
        }
        #shiftLegend i {
            color: #888;
            font-size: 15px;
        }
        /* Checkbox style */
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #1976d2;
            cursor: pointer;
            vertical-align: middle; /* Th√™m d√≤ng n√†y ƒë·ªÉ cƒÉn gi·ªØa checkbox */
        }
        /* Sologan fire effect */
        .sologan-fire {
            background: linear-gradient(90deg, #ff9800 0%, #ff5722 40%, #ffd600 60%, #ff9800 100%);
            color: #fff;
            font-size: 1.35rem;
            font-weight: bold;
            margin-bottom: 22px;
            text-align: center;
            border-radius: 12px;
            box-shadow: 0 4px 24px #ff980080, 0 0 16px #ffd60080 inset;
            padding: 16px 0 14px 0;
            letter-spacing: 1.5px;
            text-shadow:
                0 2px 8px #ff9800cc,
                0 0 12px #ffd600cc,
                0 0 2px #fff;
            position: relative;
            overflow: hidden;
            animation: fireGlow 2s infinite alternate;
            cursor: pointer;
            user-select: none;
        }
        @keyframes fireGlow {
            0% {
                box-shadow: 0 4px 24px #ff980080, 0 0 16px #ffd60080 inset;
                text-shadow:
                    0 2px 8px #ff9800cc,
                    0 0 12px #ffd600cc,
                    0 0 2px #fff;
            }
            100% {
                box-shadow: 0 8px 36px #ff5722cc, 0 0 32px #ffd600cc inset;
                text-shadow:
                    0 4px 16px #ff5722cc,
                    0 0 24px #ffd600cc,
                    0 0 6px #fff;
            }
        }
        .sologan-fire .flame {
            position: absolute;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            width: 38px;
            height: 38px;
            pointer-events: none;
            z-index: 2;
            animation: flameMove 1.2s infinite alternate;
        }
        @keyframes flameMove {
            0% { transform: translateX(-50%) scaleY(1); opacity: 1; }
            100% { transform: translateX(-50%) scaleY(1.18); opacity: 0.85; }
        }
        .sologan-fire .flame svg {
            display: block;
            width: 38px;
            height: 38px;
        }
        /* Responsive */
        @media (max-width: 900px) {
            .container { padding: 12px 2vw; }
            table, th, td { font-size: 13px; }
            #attTableWrap > div > div { font-size: 17px; }
        }
        @media (max-width: 600px) {
            .navbar { flex-direction: column; gap: 8px; padding: 10px 6px; }
            .container { padding: 6px 1vw; }
            h2 { font-size: 1.2rem; }
        }
    </style>
    <script src="menu.js"></script>
    <script src="data_io.js"></script>
</head>
<body>
    <script>renderMenu('att');</script>
    <div class="container">
        <div style="background:#fff3cd;color:#b8860b;padding:14px 22px;border-radius:10px;margin-bottom:22px;font-size:1.13rem;font-weight:600;box-shadow:0 2px 12px #ffc10750;border:2px solid #ffc107;">
            <span style="font-size:1.15rem;color:#d32f2f;font-weight:bold;letter-spacing:0.5px;">&#9888; TH√îNG B√ÅO QUAN TR·ªåNG:</span><br>
            Vui l√≤ng ch·ªçn ƒë√∫ng nh√¢n vi√™n, ch·∫•m ƒë√∫ng ca l√†m, ng√†y v√† th·ª©. <br>
            <span style="color:#d32f2f;font-size:1.07rem;font-weight:600;">M·ªçi sai s√≥t trong vi·ªác ch·∫•m thi·∫øu ca, thi·∫øu c√¥ng, thi·∫øu ti·ªÅn l∆∞∆°ng s·∫Ω do ch√≠nh nh√¢n vi√™n ch·ªãu ho√†n to√†n tr√°ch nhi·ªám. <br>H√£y ki·ªÉm tra k·ªπ tr∆∞·ªõc khi l∆∞u d·ªØ li·ªáu ch·∫•m c√¥ng!</span><br>
            <span style="color:#1976d2;font-size:1.05rem;font-weight:500;display:block;margin-top:8px;">
                M·ªçi s·ª± c·ªë k·ªπ thu·∫≠t li√™n quan ƒë·∫øn ch·∫•m c√¥ng, b·∫£ng l∆∞∆°ng, m·∫•t d·ªØ li·ªáu c√¥ng vui l√≤ng li√™n h·ªá Zalo: <b>0867544809</b>
            </span>
        </div>
        <h2>Ch·∫•m c√¥ng theo th√°ng</h2>
        <div class="form-row">
            <label style="width:130px;">Ch·ªçn c·ª≠a h√†ng:</label>
            <select id="attStoreSelect" onchange="renderEmpSelect();renderAttendance();updateSalaryTypeDisplay()" style="font-size:18px;padding:8px 18px;min-width:180px;border-radius:8px;border:1.5px solid #b3d1f7;background:#f7fbff;color:#1976d2;font-weight:500;box-shadow:0 1px 6px #1976d210;">
                <option value="">--T·∫•t c·∫£--</option>
                <option value="LepShop">LepShop</option>
                <option value="H'farm">H'farm</option>
            </select>
            <label>Ch·ªçn nh√¢n vi√™n:</label>
            <select id="empSelect" onchange="renderAttendance();updateSalaryTypeDisplay()" style="font-size:20px;padding:8px 18px;min-width:220px;border-radius:8px;">
            </select>
            <button type="button" class="btn" id="noteBtn" style="margin-left:12px;" onclick="openNoteModal()">Note</button>
        </div>
        <div class="form-row" id="salaryTypeRow" style="display:none;">
            <label>H√¨nh th·ª©c tr·∫£ l∆∞∆°ng:</label>
            <span id="salaryTypeDisplay" style="font-size:16px;color:#1976d2;font-weight:500"></span>
        </div>
        <div class="form-row">
            <label>Ch·ªçn th√°ng:</label>
            <input type="month" id="attMonth" onchange="renderAttendance()">
            <!-- <button class="btn" onclick="saveAttendanceMonth()" style="display:none;">L∆∞u ch·∫•m c√¥ng</button> -->
        </div>
        <div id="attTableWrap" style="overflow-x:auto"></div>
    </div>
    <!-- Modal for note -->
    <div id="noteModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:#0005;">
        <div style="background:#fff;padding:24px 20px 16px 20px;border-radius:10px;max-width:400px;margin:80px auto;position:relative;box-shadow:0 4px 24px #0003;">
            <h3 style="margin-top:0;color:#1976d2;font-size:20px;">Ghi ch√∫ nh√¢n vi√™n</h3>
            <div id="noteEmpName" style="font-weight:500;margin-bottom:8px;"></div>
            <textarea id="noteContent" rows="6" style="width:100%;border-radius:6px;border:1.5px solid #b3d1f7;padding:8px;font-size:15px;resize:vertical;"></textarea>
            <div style="margin-top:14px;text-align:right;">
                <button class="btn" onclick="saveNote()">L∆∞u</button>
                <button class="btn" style="background:#e53935" onclick="closeNoteModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
    <!-- Modal for copy shifts -->
    <div id="copyShiftModal" style="display:none;position:fixed;z-index:1001;left:0;top:0;width:100vw;height:100vh;background:#0005;">
        <div style="background:#fff;padding:24px 20px 16px 20px;border-radius:10px;max-width:400px;margin:80px auto;position:relative;box-shadow:0 4px 24px #0003;">
            <h3 style="margin-top:0;color:#1976d2;font-size:20px;">Copy ca l√†m t·ª´ nh√¢n vi√™n kh√°c</h3>
            <div style="margin-bottom:10px;">
                <label for="copyShiftEmpSelect" style="font-weight:500;color:#1976d2;">Ch·ªçn nh√¢n vi√™n ngu·ªìn:</label>
                <select id="copyShiftEmpSelect" style="width:100%;padding:6px 8px;border-radius:6px;margin-top:4px;"></select>
            </div>
            <div style="margin-bottom:10px;">
                <label for="copyShiftMonthSelect" style="font-weight:500;color:#1976d2;">Ch·ªçn th√°ng ngu·ªìn:</label>
                <input type="month" id="copyShiftMonthSelect" style="width:100%;padding:6px 8px;border-radius:6px;margin-top:4px;">
            </div>
            <div style="margin-top:14px;text-align:right;">
                <button class="btn" onclick="doCopyShifts()">Copy</button>
                <button class="btn" style="background:#e53935" onclick="closeCopyShiftModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>
    <script>
        let employees = JSON.parse(localStorage.getItem('employees') || '[]');
        let attendanceByMonth = JSON.parse(localStorage.getItem('attendanceByMonth') || '{}');
        let shiftsByEmp = JSON.parse(localStorage.getItem('shiftsByEmp') || '{}');
        // --- Shift setup section (per employee, per month) ---
        // Thay shiftsByEmp th√†nh shiftsByEmpByMonth
        let shiftsByEmpByMonth = JSON.parse(localStorage.getItem('shiftsByEmpByMonth') || '{}');

        function getCurrentMonth() {
            let m = document.getElementById('attMonth').value;
            if (!m) {
                const now = new Date();
                m = now.toISOString().slice(0,7);
                document.getElementById('attMonth').value = m;
            }
            return m;
        }

        function getShiftsForEmpMonth(empId, month) {
            if (!shiftsByEmpByMonth[month]) shiftsByEmpByMonth[month] = {};
            if (!shiftsByEmpByMonth[month][empId]) {
                // Copy t·ª´ th√°ng tr∆∞·ªõc n·∫øu c√≥
                let prevMonth = getPrevMonth(month);
                if (shiftsByEmpByMonth[prevMonth] && shiftsByEmpByMonth[prevMonth][empId]) {
                    // Deep copy ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng d·ªØ li·ªáu th√°ng tr∆∞·ªõc
                    shiftsByEmpByMonth[month][empId] = JSON.parse(JSON.stringify(shiftsByEmpByMonth[prevMonth][empId]));
                } else if (shiftsByEmp[empId]) {
                    // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu th√°ng n√†o, l·∫•y t·ª´ shiftsByEmp (d·ªØ li·ªáu c≈©)
                    shiftsByEmpByMonth[month][empId] = JSON.parse(JSON.stringify(shiftsByEmp[empId]));
                } else {
                    shiftsByEmpByMonth[month][empId] = [];
                }
                saveShiftsByEmpByMonth();
            }
            return shiftsByEmpByMonth[month][empId];
        }

        function saveShiftsByEmpByMonth() {
            localStorage.setItem('shiftsByEmpByMonth', JSON.stringify(shiftsByEmpByMonth));
            if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
        }

        function getPrevMonth(month) {
            let [y, m] = month.split('-').map(Number);
            if (m === 1) { y--; m = 12; } else { m--; }
            return `${y}-${String(m).padStart(2, '0')}`;
        }

        function renderEmpSelect() {
            const sel = document.getElementById('empSelect');
            const store = document.getElementById('attStoreSelect').value;
            const savedEmpId = localStorage.getItem('att_selectedEmpId');
            let filtered = employees;
            if (store) filtered = employees.filter(e => (e.store || '') === store);
            sel.innerHTML = filtered.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            if (savedEmpId && filtered.some(e => e.id === savedEmpId)) {
                sel.value = savedEmpId;
            }
        }

        document.getElementById('empSelect').addEventListener('change', function() {
            localStorage.setItem('att_selectedEmpId', this.value);
            renderAttendance();
            updateSalaryTypeDisplay();
            showMissingAttendanceAlert();
        });

        document.getElementById('attMonth').addEventListener('change', function() {
            renderAttendance();
            showMissingAttendanceAlert();
        });

        function updateSalaryTypeDisplay() {
            const empId = document.getElementById('empSelect').value;
            const emp = employees.find(e => e.id == empId);
            const row = document.getElementById('salaryTypeRow');
            const span = document.getElementById('salaryTypeDisplay');
            if (emp) {
                row.style.display = '';
                span.textContent = emp.salary_type === 'shift' ? 'L∆∞∆°ng theo ca' : 'L∆∞∆°ng c∆° b·∫£n';
            } else {
                row.style.display = 'none';
                span.textContent = '';
            }
        }

        // --- Shift setup section (per employee) ---
        function renderShifts(empId) {
            // Lu√¥n ƒë·ªìng b·ªô shiftsByEmpByMonth t·ª´ localStorage khi render
            shiftsByEmpByMonth = JSON.parse(localStorage.getItem('shiftsByEmpByMonth') || '{}');
            
            const month = getCurrentMonth();
            const tbody = document.querySelector(`#shiftTable_${empId} tbody`);
            const shifts = getShiftsForEmpMonth(empId, month);
            const emp = employees.find(e => e.id == empId);
            let salaryPerDay = parseInt(localStorage.getItem('salaryPerDay_' + empId)) 
                || parseInt(localStorage.getItem('salaryPerDay') || '0');
            tbody.innerHTML = '';
            shifts.forEach((shift, idx) => {
                if (typeof shift.half === 'undefined') shift.half = false;
                let caSalaryDisplay = salaryPerDay;
                if (emp && emp.salary_type !== 'shift') {
                    caSalaryDisplay = shift.half ? Math.round(salaryPerDay / 2) : salaryPerDay;
                }
                tbody.innerHTML += `<tr>
                    <td><input type="text" value="${shift.name}" onchange="updateShift('${empId}',${idx},'name',this.value)"></td>
                    <td>
                        <input type="time" value="${shift.start}" 
                            onchange="updateShift('${empId}',${idx},'start',this.value)" 
                            step="60"
                            min="00:00"
                            max="23:59"
                            onkeydown="if(event.key==='ArrowDown'){this.blur();}">
                    </td>
                    <td>
                        <input type="time" value="${shift.end}" 
                            onchange="updateShift('${empId}',${idx},'end',this.value)" 
                            step="60"
                            min="00:00"
                            max="23:59"
                            onkeydown="if(event.key==='ArrowDown'){this.blur();}">
                    </td>
                    <td>` +
                        (emp && emp.salary_type !== 'shift'
                            ? `<input type="text" value="${formatVND(caSalaryDisplay)}" style="width:90px;background:#eee;color:#888;" readonly tabindex="-1">`
                            : `<input type="text" value="${formatVND(shift.salary)}" style="width:90px" oninput="formatCurrencyInput(this)" onchange="updateShift('${empId}',${idx},'salary',parseCurrency(this.value))">`
                        ) +
                    `</td>
                    <td>
                        <label style="font-size:13px;">
                            <input type="checkbox" ${shift.half ? 'checked' : ''} onchange="onHalfShiftChange('${empId}',${idx},this.checked)">
                            N·ª≠a ca (0.5 c√¥ng)
                        </label>
                    </td>
                    <td><button class="btn" style="background:#e53935" onclick="deleteShift('${empId}',${idx})">X√≥a</button></td>
                </tr>`;
            });
        }

        // Th√™m h√†m n√†y ƒë·ªÉ c·∫≠p nh·∫≠t n·ª≠a ca v√† l∆∞u l·∫°i
        function onHalfShiftChange(empId, idx, checked) {
            const month = getCurrentMonth();
            let shifts = getShiftsForEmpMonth(empId, month);
            shifts[idx].half = checked;
            saveShiftsByEmpByMonth();
            renderShifts(empId);
            renderAttendance();
        }

        function addShiftRow(empId) {
            const month = getCurrentMonth();
            let shifts = getShiftsForEmpMonth(empId, month);
            // ƒê·∫£m b·∫£o lu√¥n c√≥ ƒë·ªß tr∆∞·ªùng cho ca m·ªõi
            shifts.push({ name: '', start: '', end: '', salary: 0, half: false });
            saveShiftsByEmpByMonth();
            renderShifts(empId);
            renderAttendance();
        }
        function updateShift(empId, idx, key, value) {
            const month = getCurrentMonth();
            let shifts = getShiftsForEmpMonth(empId, month);
            shifts[idx][key] = value;
            saveShiftsByEmpByMonth();
            renderAttendance();
        }
        function deleteShift(empId, idx) {
            const month = getCurrentMonth();
            let shifts = getShiftsForEmpMonth(empId, month);
            shifts.splice(idx, 1);
            // X√≥a d·ªØ li·ªáu ch·∫•m c√¥ng li√™n quan ƒë·∫øn ca b·ªã x√≥a
            for (const m in attendanceByMonth) {
                if (attendanceByMonth[m][empId]) {
                    for (const day in attendanceByMonth[m][empId]) {
                        let arr = attendanceByMonth[m][empId][day];
                        // Ensure arr is an array before using filter/map
                        if (!Array.isArray(arr)) arr = [];
                        arr = arr.filter(shiftIdx => shiftIdx !== idx);
                        arr = arr.map(shiftIdx => shiftIdx > idx ? shiftIdx - 1 : shiftIdx);
                        if (arr.length > 0) {
                            attendanceByMonth[m][empId][day] = arr;
                        } else {
                            delete attendanceByMonth[m][empId][day];
                        }
                    }
                }
            }
            saveShiftsByEmpByMonth();
            saveAttendanceMonth();
            renderShifts(empId);
            renderAttendance();
        }
        function saveShifts() {
            localStorage.setItem('shiftsByEmp', JSON.stringify(shiftsByEmp));
        }

        // --- Attendance section ---
        function daysInMonth(month) {
            const [y, m] = month.split('-').map(Number);
            return new Date(y, m, 0).getDate();
        }
        function renderAttendance() {
            // Lu√¥n ƒë·ªìng b·ªô shiftsByEmpByMonth t·ª´ localStorage khi render
            shiftsByEmpByMonth = JSON.parse(localStorage.getItem('shiftsByEmpByMonth') || '{}');
            
            const month = getCurrentMonth();
            const days = daysInMonth(month);
            const empId = document.getElementById('empSelect').value;
            if (!attendanceByMonth[month]) attendanceByMonth[month] = {};
            let html = '';
            if (employees.length === 0) {
                html = `<div style="color:#e53935;font-size:18px;padding:24px 0;text-align:center;">
                    Ch∆∞a c√≥ nh√¢n vi√™n n√†o.<br>Vui l√≤ng th√™m nh√¢n vi√™n tr∆∞·ªõc khi ch·∫•m c√¥ng.
                </div>`;
                document.getElementById('attTableWrap').innerHTML = html;
                return;
            }
            const emp = employees.find(e => e.id == empId);
            let workDaysStd = parseInt(localStorage.getItem('workDaysStd_' + empId)) 
                || parseInt(localStorage.getItem('workDaysStd') || '26');
            let salaryPerDay = parseInt(localStorage.getItem('salaryPerDay_' + empId)) 
                || parseInt(localStorage.getItem('salaryPerDay') || '0');
            if (emp) {
                let empAtt = attendanceByMonth[month][emp.id] || {};
                let shifts = getShiftsForEmpMonth(emp.id, month);
                // --- Shift setup UI for this employee ---
                html += `<div style="margin-bottom:32px;">`;
                html += `<div style="font-weight:bold;font-size:18px;margin-bottom:8px;color:#1976d2">${emp.name}</div>`;
                html += `<div><b>Thi·∫øt l·∫≠p ca l√†m:</b> 
                    <button class="btn" type="button" onclick="addShiftRow('${emp.id}')">Th√™m ca</button>
                    <button class="btn" type="button" style="background:#43a047;margin-left:8px;" onclick="openCopyShiftModal()">Copy ca t·ª´ NV kh√°c</button>
                </div>`;
                html += `<table class="shift-setup-table" id="shiftTable_${emp.id}" style="margin-top:10px;">
                    <thead>
                        <tr>
                            <th>T√™n ca</th>
                            <th>Gi·ªù b·∫Øt ƒë·∫ßu</th>
                            <th>Gi·ªù k·∫øt th√∫c</th>
                            <th>Ti·ªÅn ca</th>
                            <th>N·ª≠a ca</th>
                            <th>X√≥a</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>`;
                // X√ìA ho·∫∑c ·∫®N d√≤ng "Ca l√†m:" ph√≠a d∆∞·ªõi
                // html += `<div style="margin:8px 0 8px 0;"><b>Ca l√†m:</b> `;
                // if (shifts.length > 0) {
                //     html += shifts.map((s, i) =>
                //         `<span style="display:inline-block;margin-right:12px;">
                //             <b>${s.name || 'Ca ' + (i+1)}</b> (${formatTime24h(s.start) || '--'} - ${formatTime24h(s.end) || '--'}, ${formatVND(s.salary)})
                //         </span>`
                //     ).join('');
                // } else {
                //     html += '<i>Ch∆∞a thi·∫øt l·∫≠p ca l√†m</i>';
                // }
                // html += `</div>`;

                // --- Attendance table ---
                html += `<table style="margin-bottom:0;"><thead>`;
                html += `<tr><th style="min-width:100px">Ca</th>`;
                // Th√™m c·ªôt Th·ªùi gian
                html += `<th style="min-width:110px">Th·ªùi gian</th>`;
                for(let d=1; d<=days; ++d) {
                    const [y, m] = month.split('-').map(Number);
                    html += `<th>${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}</th>`;
                }
                html += `<th style="min-width:90px">Ca t·ªïng</th><th style="min-width:120px">T·ªïng c√¥ng</th><th style="min-width:120px">L∆∞∆°ng t·ª´ng ca</th><th style="min-width:140px">L∆∞∆°ng th·ª±c nh·∫≠n</th>`;
                html += `</tr>`;
                html += `<tr><th></th>`;
                // Th√™m c·ªôt Th·ªùi gian (d√≤ng th·ª© 2 header ƒë·ªÉ tr·ªëng)
                html += `<th></th>`;
                for(let d=1; d<=days; ++d) {
                    const [y, m] = month.split('-').map(Number);
                    const date = new Date(y, m-1, d);
                    const weekday = ['CN','T2','T3','T4','T5','T6','T7'][date.getDay()];
                    html += `<th>${weekday}</th>`;
                }
                html += `<th></th><th></th><th></th><th></th>`;
                html += `</tr></thead><tbody>`;
                let caCong = [];
                let caSalaries = [];
                let daysWithWork = new Set();
                let numShifts = shifts.length || 1;
                for(let s=0; s<numShifts; ++s) {
                    let rowWork = 0;
                    html += `<tr>`;
                    html += `<td style="text-align:left">${shifts[s]?.name || 'Ca '+(s+1)}</td>`;
                    // Th√™m c·ªôt Th·ªùi gian
                    let start = (typeof shifts[s]?.start === 'string' && shifts[s].start) ? formatTime24h(shifts[s].start) : '--';
                    let end = (typeof shifts[s]?.end === 'string' && shifts[s].end) ? formatTime24h(shifts[s].end) : '--';
                    html += `<td>${start} - ${end}</td>`;
                    for(let d=1; d<=days; ++d) {
                        let checked = (empAtt[d] && empAtt[d].includes(s)) ? 'checked' : '';
                        let shiftVal = shifts[s]?.half ? 0.5 : 1;
                        if (checked) rowWork += shiftVal;
                        if (empAtt[d] && empAtt[d].length > 0) daysWithWork.add(d);
                        html += `<td>
                            <input type="checkbox" onchange="toggleAttendanceShift('${emp.id}',${d},${s},this.checked)" ${checked}>
                            <span style="font-size:11px;color:#1976d2;">${shifts[s]?.half ? '0.5' : '1'}</span>
                        </td>`;
                    }
                    caCong[s] = rowWork;
                    let caSalary = parseInt(shifts[s]?.salary || 0);
                    let salary = rowWork * caSalary;
                    caSalaries[s] = salary;
                    html += `<td>${rowWork}</td>`;
                    // Hi·ªÉn th·ªã l∆∞∆°ng t·ª´ng ca ·ªü m·ªói h√†ng
                    html += `<td>${formatVND(salary)}</td>`;
                    // Ch·ªâ hi·ªÉn th·ªã T·ªïng c√¥ng v√† L∆∞∆°ng th·ª±c nh·∫≠n ·ªü d√≤ng cu·ªëi c√πng, c√°c d√≤ng kh√°c ƒë·ªÉ tr·ªëng
                    if (s === numShifts - 1) {
                        let totalCa = caCong.reduce((a, b) => a + b, 0);
                        let totalSalary = 0;
                        if (emp.salary_type === 'shift') {
                            totalSalary = caSalaries.reduce((a, b) => a + b, 0);
                        } else {
                            let baseSalary = emp.base_salary || 0;
                            let salary = 0;
                            if (totalCa >= workDaysStd) {
                                // N·∫øu d∆∞ c√¥ng th√¨ c·ªông th√™m s·ªë c√¥ng d∆∞ * ti·ªÅn 1 ng√†y c√¥ng
                                salary = baseSalary + ((totalCa - workDaysStd) * salaryPerDay);
                            } else {
                                // N·∫øu thi·∫øu c√¥ng th√¨ tr·ª´ ƒëi s·ªë ng√†y thi·∫øu * ti·ªÅn 1 ng√†y c√¥ng
                                salary = baseSalary - ((workDaysStd - totalCa) * salaryPerDay);
                                if (salary < 0) salary = 0;
                            }
                            totalSalary = salary;
                        }
                        html += `<td>${totalCa}</td>`;
                        html += `<td>${formatVND(totalSalary)}</td>`;
                    } else {
                        html += `<td></td><td></td>`;
                    }
                    html += `</tr>`;
                }
                html += `</tbody></table></div>`;
            }
            document.getElementById('attTableWrap').innerHTML = html;
            // Render shift setup table for selected employee
            if (emp) renderShifts(emp.id);
        }

        function toggleAttendanceShift(empId, day, shiftIdx, checked) {
            const month = getCurrentMonth();
            if (!attendanceByMonth[month]) attendanceByMonth[month] = {};
            if (!attendanceByMonth[month][empId]) attendanceByMonth[month][empId] = {};
            if (!attendanceByMonth[month][empId][day]) attendanceByMonth[month][empId][day] = [];
            let arr = attendanceByMonth[month][empId][day];
            if (checked) {
                if (!arr.includes(shiftIdx)) arr.push(shiftIdx);
            } else {
                attendanceByMonth[month][empId][day] = arr.filter(x => x !== shiftIdx);
            }
            if (attendanceByMonth[month][empId][day].length === 0) {
                delete attendanceByMonth[month][empId][day];
            }
            saveAttendanceMonth();
            renderAttendance(); // Th√™m d√≤ng n√†y ƒë·ªÉ c·∫≠p nh·∫≠t l·∫°i t·ªïng c√¥ng v√† l∆∞∆°ng th·ª±c nh·∫≠n ngay l·∫≠p t·ª©c
        }
        function saveAttendanceMonth() {
            localStorage.setItem('attendanceByMonth', JSON.stringify(attendanceByMonth));
            if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
        }
        function formatVND(val) {
            if (isNaN(val)) return '';
            return Number(val).toLocaleString('vi-VN') + ' ‚Ç´';
        }
        function parseCurrency(val) {
            return Number((val+'').replace(/[^\d]/g, '')) || 0;
        }
        function formatCurrencyInput(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (!value) value = '0';
            input.value = Number(value).toLocaleString('vi-VN');
        }
        function exportAllData() {
            const data = typeof getExportData === 'function' ? getExportData() : {};
            // L·∫•y t√™n c·ª≠a h√†ng t·ª´ localStorage
            const storeName = (localStorage.getItem('storeName') || 'LepShop').trim();
            const now = new Date();
            const pad = n => String(n).padStart(2, '0');
            const fileName = `${storeName.replace(/[^a-zA-Z0-9]/g, '')}-${pad(now.getDate())}-${pad(now.getMonth()+1)}-${now.getFullYear()}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}.json`;
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.employees && data.attendanceByMonth) {
                        // Merge employees
                        let oldEmployees = JSON.parse(localStorage.getItem('employees') || '[]');
                        let newEmployees = data.employees || [];
                        let empMap = {};
                        oldEmployees.forEach(e => empMap[e.id] = e);
                        newEmployees.forEach(e => empMap[e.id] = e);
                        let mergedEmployees = Object.values(empMap);

                        // Merge attendanceByMonth
                        let oldAtt = JSON.parse(localStorage.getItem('attendanceByMonth') || '{}');
                        let newAtt = data.attendanceByMonth || {};
                        for (let month in newAtt) {
                            if (!oldAtt[month]) oldAtt[month] = {};
                            for (let empId in newAtt[month]) {
                                if (!oldAtt[month][empId]) oldAtt[month][empId] = {};
                                for (let day in newAtt[month][empId]) {
                                    oldAtt[month][empId][day] = newAtt[month][empId][day];
                                }
                            }
                        }

                        // Merge shifts
                        let oldShifts = JSON.parse(localStorage.getItem('shifts') || '[]');
                        let newShifts = data.shifts || [];
                        let shiftMap = {};
                        oldShifts.forEach(s => shiftMap[s.id] = s);
                        newShifts.forEach(s => shiftMap[s.id] = s);
                        let mergedShifts = Object.values(shiftMap);

                        // Merge shiftsByEmp
                        let oldShiftsByEmp = JSON.parse(localStorage.getItem('shiftsByEmp') || '{}');
                        let newShiftsByEmp = data.shiftsByEmp || {};
                        for (let empId in newShiftsByEmp) {
                            if (!oldShiftsByEmp[empId]) oldShiftsByEmp[empId] = [];
                            // Merge shifts by index (append new if not exist)
                            let oldArr = oldShiftsByEmp[empId];
                            let newArr = newShiftsByEmp[empId];
                            for (let i = 0; i < newArr.length; ++i) {
                                // Avoid duplicate by name+start+end+salary
                                let exists = oldArr.some(s =>
                                    s.name === newArr[i].name &&
                                    s.start === newArr[i].start &&
                                    s.end === newArr[i].end &&
                                    s.salary === newArr[i].salary
                                );
                                if (!exists) oldArr.push(newArr[i]);
                            }
                        }

                        // Merge workDaysStd & salaryPerDay (∆∞u ti√™n gi·ªØ gi√° tr·ªã l·ªõn nh·∫•t)
                        let workDaysStd = Math.max(
                            parseInt(localStorage.getItem('workDaysStd') || '26'),
                            parseInt(data.workDaysStd || '26')
                        );
                        let salaryPerDay = Math.max(
                            parseInt(localStorage.getItem('salaryPerDay') || '0'),
                            parseInt(data.salaryPerDay || '0')
                        );

                        // Save merged data
                        localStorage.setItem('employees', JSON.stringify(mergedEmployees));
                        localStorage.setItem('attendanceByMonth', JSON.stringify(oldAtt));
                        localStorage.setItem('shifts', JSON.stringify(mergedShifts));
                        localStorage.setItem('shiftsByEmp', JSON.stringify(oldShiftsByEmp));
                        localStorage.setItem('workDaysStd', workDaysStd.toString());
                        localStorage.setItem('salaryPerDay', salaryPerDay.toString());

                        // Merge notes n·∫øu c√≥
                        if (data.notes) {
                            // X√≥a h·∫øt c√°c ghi ch√∫ c≈© tr∆∞·ªõc khi import ƒë·ªÉ tr√°nh tr√πng l·∫∑p/kh√¥ng ƒë·ªìng b·ªô
                            Object.keys(localStorage).forEach(k => {
                                if (k.startsWith('note_')) localStorage.removeItem(k);
                            });
                            for (let k in data.notes) {
                                localStorage.setItem(k, data.notes[k]);
                            }
                        }

                        alert('Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng! Trang s·∫Ω ƒë∆∞·ª£c t·∫£i l·∫°i.');
                        if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
                        location.reload();
                    } else {
                        alert('File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!');
                    }
                } catch (err) {
                    alert('L·ªói khi ƒë·ªçc file d·ªØ li·ªáu!');
                }
            };
            reader.readAsText(file);
        }
        // Set default month and render
        (function(){
            const now = new Date();
            const ym = now.toISOString().slice(0,7);
            document.getElementById('attMonth').value = ym;
            renderEmpSelect();
            renderAttendance();
            updateSalaryTypeDisplay();
            showMissingAttendanceAlert();
        })();

        function formatTime24h(val) {
            if (!val) return '';
            const [h, m] = val.split(':');
            return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
        }

        // Th√™m h√†m hi·ªÉn th·ªã gi·ªù 12h v·ªõi AM/PM ti·∫øng Anh
        function formatTime12h(val) {
            if (!val) return '';
            const [h, m] = val.split(':').map(Number);
            let hour = h % 12 || 12;
            let ampm = h < 12 ? 'AM' : 'PM';
            return `${hour}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        // Note functions
        function getNoteKey() {
            const empId = document.getElementById('empSelect').value;
            const month = document.getElementById('attMonth').value;
            return `note_${empId}_${month}`;
        }
        function openNoteModal() {
            const empId = document.getElementById('empSelect').value;
            const month = document.getElementById('attMonth').value;
            const emp = employees.find(e => e.id == empId);
            document.getElementById('noteEmpName').textContent = emp ? `${emp.name} - Th√°ng ${month}` : '';
            document.getElementById('noteContent').value = localStorage.getItem(getNoteKey()) || '';
            document.getElementById('noteModal').style.display = '';
        }
        function closeNoteModal() {
            document.getElementById('noteModal').style.display = 'none';
        }
        function saveNote() {
            localStorage.setItem(getNoteKey(), document.getElementById('noteContent').value);
            if (typeof autoSendDataToTelegramBot === 'function') autoSendDataToTelegramBot();
            closeNoteModal();
        }
        // ƒê√≥ng modal khi b·∫•m ra ngo√†i
        document.addEventListener('mousedown', function(e) {
            const modal = document.getElementById('noteModal');
            if (modal.style.display !== 'none' && !modal.querySelector('div').contains(e.target)) {
                closeNoteModal();
            }
        });

        // --- Copy shift functions ---
        function openCopyShiftModal() {
            // Fill employee select except current
            const empId = document.getElementById('empSelect').value;
            const sel = document.getElementById('copyShiftEmpSelect');
            sel.innerHTML = employees
                .filter(e => e.id != empId)
                .map(e => `<option value="${e.id}">${e.name}</option>`)
                .join('');
            // Default month: current month
            document.getElementById('copyShiftMonthSelect').value = getCurrentMonth();
            document.getElementById('copyShiftModal').style.display = '';
        }
        function closeCopyShiftModal() {
            document.getElementById('copyShiftModal').style.display = 'none';
        }
        function doCopyShifts() {
            const empId = document.getElementById('empSelect').value;
            const month = getCurrentMonth();
            const sourceEmpId = document.getElementById('copyShiftEmpSelect').value;
            const sourceMonth = document.getElementById('copyShiftMonthSelect').value;
            if (!sourceEmpId) return;

            // L·∫•y ca l√†m c·ªßa nh√¢n vi√™n ngu·ªìn trong th√°ng ngu·ªìn
            let sourceShifts = getShiftsForEmpMonth(sourceEmpId, sourceMonth);
            // L∆∞u l·∫°i ƒë·ªÉ ki·ªÉm tra sau
            let backupShifts = JSON.parse(JSON.stringify(shiftsByEmpByMonth));

            // G√°n ca l√†m cho nh√¢n vi√™n ƒë√≠ch
            shiftsByEmpByMonth[month][empId] = JSON.parse(JSON.stringify(sourceShifts));
            saveShiftsByEmpByMonth();

            // Ki·ªÉm tra v√† th√¥ng b√°o k·∫øt qu·∫£
            let resultMsg = 'Copy ca l√†m th√†nh c√¥ng!';
            // So s√°nh d·ªØ li·ªáu tr∆∞·ªõc v√† sau khi copy ƒë·ªÉ th√¥ng b√°o c·ª• th·ªÉ h∆°n
            let isChanged = false;
            let sourceShiftNames = sourceShifts.map(s => s.name).join(', ');
            let targetShiftNames = backupShifts[month][empId]?.map(s => s.name).join(', ') || 'Kh√¥ng c√≥ ca l√†m n√†o';
            if (JSON.stringify(backupShifts[month][empId]) !== JSON.stringify(shiftsByEmpByMonth[month][empId])) {
                isChanged = true;
                resultMsg += `\n- Ca ngu·ªìn: ${sourceShiftNames}\n- Ca ƒë√≠ch: ${targetShiftNames}`;
            }
            alert(resultMsg);
            closeCopyShiftModal();
            renderAttendance();
        }

        // Th√™m h√†m c·∫£nh b√°o n·∫øu nh√¢n vi√™n c√≥ nhi·ªÅu ng√†y kh√¥ng ch·∫•m c√¥ng (ch·ªâ t√≠nh ƒë·∫øn ng√†y hi·ªán t·∫°i)
        function showMissingAttendanceAlert() {
            const empId = document.getElementById('empSelect').value;
            const month = document.getElementById('attMonth').value;
            if (!empId || !month) return;
            const days = daysInMonth(month);
            let empAtt = (attendanceByMonth[month] && attendanceByMonth[month][empId]) || {};
            const now = new Date();
            const [y, m] = month.split('-').map(Number);
            let maxDay = days;
            if (now.getFullYear() === y && (now.getMonth() + 1) === m) {
                maxDay = now.getDate();
            }
            // Ki·ªÉm tra c√≥ ng√†y n√†o ƒë√£ ch·∫•m c√¥ng kh√¥ng
            let hasAnyAttendance = false;
            for (let d = 1; d <= maxDay; ++d) {
                if (empAtt[d] && Array.isArray(empAtt[d]) && empAtt[d].length > 0) {
                    hasAnyAttendance = true;
                    break;
                }
            }
            // N·∫øu kh√¥ng c√≥ ng√†y n√†o ƒë∆∞·ª£c ch·∫•m c√¥ng th√¨ m·ªõi hi·ªán th√¥ng b√°o
            if (!hasAnyAttendance && maxDay > 0) {
                const emp = employees.find(e => e.id == empId);
                const empName = emp ? emp.name : 'B·∫°n';
                let msg = `B·∫°n <b>${empName}</b> ∆°i, t·ª´ ƒë·∫ßu th√°ng ƒë·∫øn gi·ªù b·∫°n ch∆∞a ch·∫•m c√¥ng ng√†y n√†o lu√¥n √°!<br>Nh·ªõ ch·∫•m c√¥ng ƒë·ªÉ kh√¥ng b·ªã ·∫£nh h∆∞·ªüng l∆∞∆°ng nha üòÖ`;
                if (!document.getElementById('missingAttAlert')) {
                    const div = document.createElement('div');
                    div.id = 'missingAttAlert';
                    div.style.position = 'fixed';
                    div.style.top = '0';
                    div.style.left = '0';
                    div.style.width = '100vw';
                    div.style.height = '100vh';
                    div.style.display = 'flex';
                    div.style.alignItems = 'center';
                    div.style.justifyContent = 'center';
                    div.style.background = 'rgba(0,0,0,0.18)';
                    div.style.zIndex = '2000';
                    div.innerHTML = `
                        <div style="
                            background:#fff3cd;
                            color:#b8860b;
                            padding:24px 36px;
                            border-radius:16px;
                            box-shadow:0 4px 24px #ffc10780;
                            font-size:1.13rem;
                            font-weight:600;
                            max-width:90vw;
                            text-align:center;
                            border:2px solid #ffc107;
                            display:flex;
                            flex-direction:column;
                            align-items:center;
                            ">
                            <div style="margin-bottom:10px;">
                                <!-- Animated bell SVG -->
                                <svg width="110" height="110" viewBox="0 0 72 72" style="display:inline-block;" xmlns="http://www.w3.org/2000/svg">
                                    <g>
                                        <g>
                                            <animateTransform attributeName="transform"
                                                type="rotate"
                                                values="-10 36 36;10 36 36;-10 36 36"
                                                keyTimes="0;0.5;1"
                                                dur="1.2s"
                                                repeatCount="indefinite"/>
                                            <path d="M36 12c-9 0-16 7-16 16v10c0 2-1 4-3 5v3h38v-3c-2-1-3-3-3-5V28c0-9-7-16-16-16z"
                                                fill="#ffc107" stroke="#b8860b" stroke-width="2"/>
                                            <ellipse cx="36" cy="56" rx="8" ry="4" fill="#ffe082"/>
                                            <circle cx="36" cy="60" r="4" fill="#ffb300" stroke="#b8860b" stroke-width="1"/>
                                        </g>
                                        <circle cx="36" cy="10" r="3" fill="#ffb300" stroke="#b8860b" stroke-width="1"/>
                                    </g>
                                </svg>
                            </div>
                            <span style="font-size:1.25rem;color:#d32f2f;font-weight:bold;">&#9888;</span>
                            <div style="margin-top:6px;">${msg}</div>
                            <button onclick="document.getElementById('missingAttAlert').remove()" style="margin-top:18px;background:#e53935;color:#fff;border:none;border-radius:8px;padding:6px 24px;cursor:pointer;font-size:1.05rem;">ƒê√≥ng</button>
                        </div>
                    `;
                    document.body.appendChild(div);
                    setTimeout(() => { if (div.parentNode) div.parentNode.removeChild(div); }, 8000);
                }
            } else {
                const div = document.getElementById('missingAttAlert');
                if (div) div.remove();
            }
        }
    </script>
    <script src="footer.js"></script>
    <script>renderFooter();</script>
</body>
</html>
